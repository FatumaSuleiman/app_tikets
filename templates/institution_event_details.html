{% extends 'base_layout.html' %}
{% load static %}

{% block title %}
    Event Details
{% endblock %}

{% block additional_assets %}
    <script src="{% static 'js/vue.js' %}"></script>
    <script src="{% static 'js/axios.min.js' %}"></script>
{% endblock %}

{% block body %}
<div class="row mx-1">
    <div class="col-md-12">
        <ul class="breadcrumb">
            <li><a href="/institutions/get_institutions">Institutions</a></li>
        </ul>
    </div>
</div>
  <div id="app" data-institution-id="{{ inst_id }}" data-event-id="{{ event_id }}">
        <!-- Event Details Section -->
        {% if event_data %}
            <div class="card ml-3" style="width:90em;">
                <div class="card-body">
                    <h3>Event Details</h3>
                    <p><strong>Name:</strong> {{ event_data.name }}</p>
                    <p><strong>Event Location:</strong> {{ event_data.eventLocation }}</p>
                    <p><strong>Description:</strong> {{ event_data.description }}</p>
                    <p><strong>Date:</strong> {{ event_data.date }}</p>
                    <p><strong>Time:</strong> {{ event_data.time }}</p>
                </div>
            </div>
        {% endif %}
        
        <!-- Ticket Search Section -->
        <div class=" row mx-1 search">
                <div style="width:90em;"  class="ml-3" v-if="!showSearchTable">
                    <h3>Select to search tickets</h3>
                    <select class="mb-3 form-control" v-model="searchType">
                        <option value="" disabled>Select to search tickets</option>
                        <option value="paymentNumber">Search by Payment Number</option>
                        <option value="phone">Search by Phone</option>
                        <option value="validatedByPaymentNumber">Search validated tickets</option>
                        <option value="Dates">Search by Dates</option>
                    </select>
                
                    <!-- Dynamic forms based on search type -->
                    <div v-if="searchType === 'paymentNumber'">
                        <h3>Search Ticket by Payment Number</h3>
                        <form @submit.prevent="searchTicketByPaymentNumber">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" placeholder="Payment Number" v-model="search_data.paymentNumber">
                                </div>
                            </div>
                            <div class="row mt-5">
                                <div class="col-md-6">
                                    <span class="text-danger" v-shaw="errorMessage">[[ errorMessage ]]</span>
                                <button type="submit" class="btn btn-primary form-control" style="border-radius:10px fs-6">Search By Payment Number</button>
                            </div>
                        </div>
                        </form>
                    </div>
                    <div v-if="searchType === 'validatedByPaymentNumber'">
                        <h3>Search validated Ticket by Payment Number</h3>
                        <form @submit.prevent="searchValidatedTicketByPaymentNumber">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" placeholder="Payment Number" v-model="search_validated_tickets.paymentNumber">
                                </div>
                            </div>
                            <div class="row mt-5">
                                <div class="col-md-6">
                                    <span class="text-danger" v-shaw="errorMessage">[[ errorMessage ]]</span>
                                <button type="submit" class="btn btn-primary form-control " style="border-radius:10px  fs-6">Search By Payment Number</button>
                            </div>
                        </div>
                        </form>
                    </div>
                    <div v-if="searchType === 'phone'">
                        <h3>Search Ticket by Phone</h3>
                        <form @submit.prevent="searchTicketByPhone">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" placeholder="Phone Number" v-model="search_by_phone.phone">
                                </div>
                            </div>
                            <div class="row mt-5 ">
                                <div class="col-md-6">
                                    <span class="text-danger" v-shaw="errorMessage">[[ errorMessage ]]</span>
                                <button type="submit" class="btn btn-primary form-control " style="border-radius:10px  fs-6">Search By Phone</button>
                            </div>
                        </div>
                        </form>
                    </div>
                    <div v-if="searchType === 'Dates'">
                        <h3>Search Ticket by Dates</h3>
                        <form @submit.prevent="searchTicketByDates">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="start_date">Start Date</label>
                                    <input type="date" class="form-control" v-model="search_by_dates.start_date">
                                </div>
                                <div class="col-md-6">
                                    <label for="end_date">End Date</label>
                                    <input type="date" class="form-control" v-model="search_by_dates.end_date">
                                </div>
                            </div>
                            <div class="row mt-5 ">
                                <div class="col-md-12">
                                    <span class="text-danger" v-shaw="errorMessage">[[ errorMessage ]]</span>
                                <button type="submit" class="btn btn-primary form-control " style="border-radius:20px  fs-6">Search By Dates</button>
                            </div>
                        </div>
                        </form>
                    </div>
                </div>
            <!-- Search Results Table -->
            <div v-if="showSearchTable" style="width:50em;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="bg-dark text-white">
                            <tr>
                                <th>No</th>
                                <th>Amount</th>
                                <th>Name</th>
                                <th>Payment Number</th>
                                <th>Payment Time</th>
                                <th>Phone</th>
                                <th>Reason</th>
                                <th>Single Purchase Amount</th>
                                <th>Ticket Category ID</th>
                                <th>Ticket Number</th>
                                <th>Valid</th>
                                <th>Validated</th>
                                <th>Validated At</th>
                                <th>Validated By</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(ticket, index) in ticketDetails" :key="index">
                                <td>[[ index + 1 ]]</td>
                                <td>[[ ticket.amount ]]</td>
                                <td>[[ ticket.name ]]</td>
                                <td>[[ ticket.paymentNumber ]]</td>
                                <td>[[ ticket.paymentTime ]]</td>
                                <td>[[ ticket.phone ]]</td>
                                <td>[[ ticket.reason ]]</td>
                                <td>[[ ticket.singlePurchaseAmount ]]</td>
                                <td>[[ ticket.ticketCategoryId ]]</td>
                                <td>[[ ticket.ticketNumber ]]</td>
                                <td>[[ ticket.valid ]]</td>
                                <td>[[ ticket.validated ]]</td>
                                <td>[[ ticket.validatedAt ]]</td>
                                <td>[[ ticket.validatedBy ]]</td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-btn-primary" @click="showSearchTable = false">Back to Search</button>
                </div>
            </div>
        </div>

        <!-- Ticket Categories Section -->
        <div class="row mx-1">
            <div class="col-md-12 mb-3">
                <div class="categories">
                    <div v-if="showForm1" class="card mb-3">
                        <div class="card-body">
                            <h3 class="text-center">Add Event Category</h3>
                            <form @submit.prevent="createTicketCategory">
                                <div  class="row mb-3">
                                    <div class="col-md-6 mb-2">
                                        <label>Name:</label>
                                        <input type="text" class="form-control" placeholder="Name" v-model="newTicketCategory.name">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label>CategoryId:</label>
                                        <input type="text" class="form-control" placeholder="CategoryId" v-model="newTicketCategory.category_id">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-2">
                                        <label>Amount:</label>
                                        <input type="text" class="form-control" placeholder="Amount" v-model="newTicketCategory.amount">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label>Group Quantity:</label>
                                        <input type="text" class="form-control" placeholder="Group Quantity" v-model="newTicketCategory.group_quantity">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-2">
                                        <label>Quantity:</label>
                                        <input type="text" class="form-control" placeholder="Quantity" v-model="newTicketCategory.quantity">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label>IsFree:</label>
                                        <div>
                                            <input type="radio" id="is_free-true" value="True" v-model="newTicketCategory.is_free">
                                            <label for="is_free-true">True</label>
                                        </div>
                                        <div>
                                            <input type="radio" id="is_free-false" value="False" v-model="newTicketCategory.is_free">
                                            <label for="is_free-false">False</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                <label>IsGroup:</label>
                                <div>
                                    <input type="radio" id="is_group-true" value="True" v-model="newTicketCategory.is_group">
                                    <label for="is_group-true">True</label>
                                </div>
                                <div>
                                    <input type="radio" id="is_group-false" value="False" v-model="newTicketCategory.is_group">
                                    <label for="is_group-false">False</label>
                                </div>
                                </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="categories_messages">
                                            <span v-if="successMessage" class="text-success text-center">
                                                [[this.successMessage]]
                                            </span>
                                        <span v-if ="errorMessage" class="error text-danger text-center" >[[this.errorMessage]]</span>
                                        </div>
                                        <button type="submit" class="btn btn-warning form-control" style="border-radius:20px; font-size:small;">Create</button>
                                    </div>
                                    <div class ="col-md-6">
                                        <button type="button" class="btn btn-secondary ml-2 form-control " style="border-radius:20px; font-size:small;" @click="handleCancelButton">Cancel</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card ml-2" style="width:90em;">
                        <div class="card-body">
                            <div class="float-left mb-3">
                                <button type="button" class="btn btn-primary text-white" style="border-radius:5px;font-size:small" @click="viewForm">Add Ticket Category</button>
                            </div>
                            <h3 class="text-center">List of  Event Categories</h3>
                            <div class="table-responsive">
                                {% verbatim %}
                                <table v-if="showTable1" class="table table-striped table-hover">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th class="text-white bg-dark">No</th>
                                            <th class="text-white bg-dark">Name</th>
                                            <th class="text-white bg-dark">CategoryId</th>
                                            <th class="text-white bg-dark">Amount</th>
                                            <th class="text-white bg-dark">Quantity</th>
                                            <th class="text-white bg-dark">GroupQuantity</th>
                                            <th class="text-white bg-dark">IsFree</th>
                                            <th class="text-white bg-dark">IsGroup</th>
                                            <th class="text-white bg-dark">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="(category, index) in categories" :key="category.category_id">
                                            <td>[[ index + 1 ]]</td>
                                            <td>[[ category.name ]]</td>
                                            <td>[[ category.category_id ]]</td>
                                            <td>[[ category.amount ]]</td>
                                            <td>[[ category.quantity ]]</td>
                                            <td>[[ category.group_quantity ]]</td>
                                            <td>[[ category.is_free ]]</td>
                                            <td>[[ category.is_group ]]</td>
                                            <td>
                                                <div style="display:flex; justify-content:space-between;">
                                                    <a :href="`/institutions/${institutionId}/events/${eventId}/ticketCategory/${category.ticket_category_id}`" style="margin-right: 20px;">Details</a>
                                                    <a :href="`/institutions/${institutionId}/categories/${eventId}/${category.ticket_category_id}/updateTicket_category`">Update</a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                                {% endverbatim %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ticket Generation Section -->
            <div class="col-md-12 mb-3">
                <div class="tickets">
                    <div v-if="showFormt" class="card mb-3">
                        <div class="card-body">
                            <h3>Generate Tickets</h3>
                            <form @submit.prevent="generateTicket">
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-2">
                                        <label>Sender:</label>
                                        <input type="text" class="form-control" placeholder="Sender" v-model="ticket.sender">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label>SenderPhone:</label>
                                        <input type="text" class="form-control" placeholder="SenderPhone" v-model="ticket.senderPhone">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-2">
                                        <label>Amount:</label>
                                        <input type="text" class="form-control" placeholder="Amount" v-model="ticket.amount">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label>Transaction Number:</label>
                                        <input type="text" class="form-control" placeholder="Transaction Number" v-model="ticket.transactionNumber">
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6 mb-2">
                                        <label>Transaction Time</label>
                                        <input type="text" class="form-control" placeholder="Transaction Time" v-model="ticket.transactionTime">
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label>Reference Number:</label>
                                        <input type="text" class="form-control" placeholder="Reference Number" v-model="ticket.referenceNumber">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="tickets_messages">
                                        <span  v-if="errorMessage" class=" text-center text-danger"> [[this.errorMessage]]</span>
                                        <span v-if ="successMessage" class ="text-success"> [[this.successMessage]]</span>
                                        </div>
                                        <button type="submit" class="btn btn-warning form-control  " style="border-radius:5px;font-size:small;">Generate</button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-secondary ml-2 form-control "  style="border-radius:5px;font-size:small;" @click="handlecancelT">Cancel</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- generate ticket by excel-->

                    <div v-if="showExcelForm">
                        <form @submit.prevent="generateTicketByExcel">
                            <div class="row mb-3">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <input type="text" class="form-control" placeholder="Category ID" v-model="excel_data.categ_id">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <input type="file" class="form-control-file" id="excelFile" ref="excelFile" @change="handleFileUpload">
                                </div>
                            </div class="excel_file">
                            <span class="text-danger" v-if="errorMessage">[[ errorMessage ]]</span>
                            <span class="text-success" v-if="successMessage">[[ successMessage ]]</span>
                            <button type="submit" class="btn btn-warning " style="border-radius:5px ;font-size:small; ">Generate Tickets by excel</button>
                            <button type ="button" class="btn btn-secondary" style="border-radius:5px;font-size:small;" @click="handleExcelCancel">Cancel</button>
                        </form>
                    </div>
                    <div v-if="showTable2" class="card ml-2" style="width:90em;">
                        <div class="card-body">
                            <div class="float-right mb-3">
                                <button class="btn btn-primary " style="border-radius:5px;font-size:small; " @click="handleAddNewTickets">Generate Ticket</button>
                            </div>
                            <div class="float-left mb-3">
                                <input type="file" id="hiddenExcelFile" ref="hiddenExcelFile" @change="handleFileUpload" style="display: none;">
                                <button @click="triggerFileInput" class="btn btn-primary " style="border-radius:5px;font-size:small;" >Upload Excel File</button>
                            </div>
                            <h3 class="text-center">List of Tickets</h3>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-white bg-dark">No</th>
                                            <th class="text-white bg-dark">Name</th>
                                            <th class="text-white bg-dark">PaymentNumber</th>
                                            <th class="text-white bg-dark">Amount</th>
                                            <th class="text-white bg-dark">paymentTime</th>
                                            <th class="text-white bg-dark">Phone</th>
                                            <th class="text-white bg-dark">Valid</th>
                                            <th class="text-white bg-dark">Validated</th>
                                            <th class="text-white bg-dark">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% verbatim %}
                                        <tr v-for="(ticket, index) in tickets" :key="ticket.ticketNumber">
                                            <td> [[index + 1 ]]</td>
                                            <td> [[ticket.name]]</td>
                                            <td>[[ ticket.paymentNumber ]]</td>
                                            <td>[[ ticket.amount ]]</td>
                                            <td>[[ ticket.paymentTime ]]</td>
                                            <td>[[ ticket.phone ]]</td>
                                            <td>[[ ticket.valid | yesno("Yes", "No") ]]</td>
                                            <td>[[ ticket.validated ]]</td>
                                            <td>
                                            <button type="button"class=" btn btn-primary "  style="border-radius:5px;font-size:small;" @click="sendSmsTicket">Send sms</button>
                                        </td>
                                        </tr>
                                        {% endverbatim %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
<script>
    Vue.filter('yesno', function (value) {
        return value ? 'Yes' : 'No';
    });
    new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            institutionId: '',
            eventId: '',
            categId:'',
            eventID:'',
            showTable1: true,
            showForm1: false,
            showFormt: false,
            showTable2: true,
            showExcelForm:false,
            categories: [],
            tickets: [], 
            search_data: {
                paymentNumber: ''
            },
            search_by_phone: {
                phone: ''
            },
            search_validated_tickets: {
                paymentNumber: ''
            },
            search_by_dates: {
                start_date: '',
                end_date: ''
            },
            ticketDetails: [],
            showSearchTable: false,
            searchType: '',

            newTicketCategory: {
                name: '',
                category_id: '',
                amount: '',
                quantity: '',
                group_quantity: '',
                is_free: '',
                is_group: ''
            },
            existingCategoryIds: [],
           successMessage: '',
           errorMessage:'',
            ticket: {
                sender: '',
                senderPhone: '',
                amount: '',
                transactionNumber: '',
                transactionTime: '',
                referenceNumber: ''
            },
            showExcelForm: false,
            file: null,
            selectedCategoryId: null,
            excel_data: {
                categ_id:''
            }
           
        },
        mounted() {
            this.institutionId = this.$el.getAttribute('data-institution-id');
            this.eventId = this.$el.getAttribute('data-event-id');
            this.eventTicketCategories();
            this.getEventTickets();
            
        },
        methods: {
            formatDate(dateString) {
                const date = new Date(dateString);
                const formattedDate = `${date.getFullYear()}-${('0' + (date.getMonth() + 1)).slice(-2)}-${('0' + date.getDate()).slice(-2)}`;
                return formattedDate;
              },
            searchTicketByPaymentNumber() {
                const token = localStorage.getItem('token');
                const payload = {
                    paymentNumber: this.search_data.paymentNumber,
                    instId: this.institutionId,
                    eventId: this.eventId
                };
                axios.post('/tickets/searchTicketByPaymentNumber', payload, {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                        'Authorization': token
                    }
                })
                .then(response => {
                    this.ticketDetails = response.data.map(ticket => ({
                        amount: ticket.amount,
                        name: ticket.name,
                        phone: ticket.phone,
                        paymentNumber: ticket.paymentNumber,
                        paymentTime: ticket.paymentTime,
                        reason: ticket.reason,
                        singlePurchaseAmount: ticket.singlePurchaseAmount,
                        ticketNumber: ticket.ticketNumber,
                        ticketCategoryId: ticket.ticketCategoryId,
                        valid: ticket.valid,
                        validated: ticket.validated,
                        validatedAt: ticket.validatedAt,
                        validatedBy: ticket.validatedBy
                    }));
                    this.showSearchTable = true;
                })
                .catch(error => {
                    this.errorMessage =`Error searching by payment number:, ${error}`;
                    setTimeout(this.clearMessages,3000);
                });
            },
            searchTicketByPhone() {
                const token = localStorage.getItem('token');
                const payload = {
                    phone: this.search_by_phone.phone,
                    instId: this.institutionId,
                    eventId: this.eventId
                };
                axios.post('/nokandaService/ticket/searchTicketByPhone', payload, {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                        'Authorization': token
                    }
                })
                .then(response => {
                    this.ticketDetails = response.data.map(ticket => ({
                        amount: ticket.amount,
                        name: ticket.name,
                        phone: ticket.phone,
                        paymentNumber: ticket.paymentNumber,
                        paymentTime: ticket.paymentTime,
                        reason: ticket.reason,
                        singlePurchaseAmount: ticket.singlePurchaseAmount,
                        ticketNumber: ticket.ticketNumber,
                        ticketCategoryId: ticket.ticketCategoryId,
                        valid: ticket.valid,
                        validated: ticket.validated,
                        validatedAt: ticket.validatedAt,
                        validatedBy: ticket.validatedBy
                    }));
                    this.showSearchTable = true;
                })
                .catch(error => {
                    this.errorMessage =`Error searching by phone: ${error}`;
                    setTimeout(this.clearMessages,3000);
                });
            },
            searchValidatedTicketByPaymentNumber() {
                const token = localStorage.getItem('token');
                const payload = {
                    paymentNumber: this.search_validated_tickets.paymentNumber,
                    instId: this.institutionId,
                    eventId: this.eventId
                };
                axios.post('/tickets/searchValidatedTicketsByPaymentNumber', payload, {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                        'Authorization': token
                    }
                })
                .then(response => {
                    this.ticketDetails = response.data.map(ticket => ({
                        amount: ticket.amount,
                        name: ticket.name,
                        phone: ticket.phone,
                        paymentNumber: ticket.paymentNumber,
                        paymentTime: ticket.paymentTime,
                        reason: ticket.reason,
                        singlePurchaseAmount: ticket.singlePurchaseAmount,
                        ticketNumber: ticket.ticketNumber,
                        ticketCategoryId: ticket.ticketCategoryId,
                        valid: ticket.valid,
                        validated: ticket.validated,
                        validatedAt: ticket.validatedAt,
                        validatedBy: ticket.validatedBy
                    }));
                    this.showSearchTable = true;
                })
                .catch(error => {
                    this.errorMessage = `Error searching validated tickets by payment number: ${error}`;
                    setTimeout(this.clearMessages,3000);
                });
            },
            searchTicketByDates() {
                const token = localStorage.getItem('token');
                const formattedStartDate = this.formatDate(this.search_by_dates.start_date);
                const formattedEndDate = this.formatDate(this.search_by_dates.end_date);
                console.log('Formatted Start Date:', formattedStartDate);
                console.log('Formatted End Date:', formattedEndDate);

                const payload = {
                    start_date: formattedStartDate,
                    end_date: formattedEndDate,
                    instId: this.institutionId,
                    eventId: this.eventId
                };
                axios.post('/tickets/generate/tickets_from_startDate_to_endDate', payload, {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                        'Authorization': token
                    }
                })
                .then(response => {
                    this.ticketDetails = response.data.map(ticket => ({
                        amount: ticket.amount,
                        name: ticket.name,
                        phone: ticket.phone,
                        paymentNumber: ticket.paymentNumber,
                        paymentTime: ticket.paymentTime,
                        reason: ticket.reason,
                        singlePurchaseAmount: ticket.singlePurchaseAmount,
                        ticketNumber: ticket.ticketNumber,
                        ticketCategoryId: ticket.ticketCategoryId,
                        valid: ticket.valid,
                        validated: ticket.validated,
                        validatedAt: ticket.validatedAt,
                        validatedBy: ticket.validatedBy
                    }));
                    this.showSearchTable = true;
                })
                .catch(error => {
                    this.errorMessage = `Error searching by dates:${error}`;
                    setTimeout(this.clearMessages,3000);
                });
            },
            eventTicketCategories() {
                const token = localStorage.getItem('token');
                axios.get(`/categories/getAll_EventCategories/${this.institutionId}/${this.eventId}`, {
                    headers: {
                      'X-CSRFToken': "{{ csrf_token }}",
                      'Authorization': token
                    }
                  })
                  .then(response => {
                    if (Array.isArray(response.data.data)) {
                      this.categories = response.data.data.map(category => ({
                        ticket_category_id: category.ticket_category_id,
                        name: category.category_data.name,
                        category_id: category.category_data.category_id,
                        amount: category.category_data.amount,
                        quantity: category.category_data.quantity,
                        group_quantity: category.category_data.group_quantity,
                        is_free: category.category_data.is_free,
                        is_group: category.category_data.is_group
                      }));
                      // Optionally set the first category as the default selected category
                      if (this.categories.length > 0) {
                        this.selectedCategoryId = this.categories[0].ticket_category_id;
                      }
                    } else {
                      console.error('Unexpected response data format:', response.data);
                    }
                  })
                  .catch(error => {
                    console.error('Error fetching categories of event:', error);
                  });
              },
            createTicketCategory() {
                if (!this.newTicketCategory.name || !this.newTicketCategory.category_id) {
                    this.errorMessage = 'Name and Category ID are required.';
                       console.log(this.errorMessage);
                       setTimeout(this.clearMessages,3000);
                    return;
                }
                if (this.existingCategoryIds.includes(this.newTicketCategory.category_id)) {
                    this.errorMessage = 'Category ID must be unique.';
                       console.log(this.errorMessage);
                       setTimeout(this.clearMessages,3000);
                    return;
                }

                const token = localStorage.getItem('token');

                const url = `/categories/saveTicketCategory/${this.institutionId}/${this.eventId}`;

                axios.post(url, this.newTicketCategory, {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                        'Authorization': token
                    }
                })
                .then(response => {
                    this.successMessage = 'TicketCategory created successfully';
                    this.existingCategoryIds.push(this.newTicketCategory.category_id);

                    this.newTicketCategory = {
                        name: '',
                        category_id: '',
                        amount: '',
                        quantity: '',
                        group_quantity: '',
                        is_free: '',
                        is_group: ''
                    };

                    //this.showForm1 = false; 
                    //this.showTable1 = true;
                })
                .catch(error => {
                    this.errorMessage = `Error creating TicketCategory: ${error}`;
                       console.log(this.errorMessage);
                       setTimeout(this.clearMessages,3000);
                });
            },
            viewForm() {
                this.showForm1 = true;
                this.showTable1 = false;
            },
            handleCancelButton() {
                this.showForm1 = false;
                this.showTable1 = true;
            },
            viewFormt() {
                this.showFormt = true;
                this.showTable2 = false;
            },
            viewTablet() {
                this.showTable2 = true;
                this.showFormt = false;
            },
            handleAddNewTickets() {
                this.viewFormt();
            },
            handlecancelT() {
                this.showFormt = false;
                this.showTable2 = true;
            },
            handleExcelCancel() {
                this.showExcelForm = false;
                this.showTable2 = true;
            },
            generateTicket() {
                const token = localStorage.getItem('token');
                const institutionId = this.$el.getAttribute('data-institution-id');
                const eventId = this.$el.getAttribute('data-event-id');
                this.eventID = '{{event_data.eventID}}'
                console.log('the eventID:',this.eventID)
                const url = `/tickets/ticket/generate_v3/${institutionId}/${this.eventID}`;

                axios.post(url, this.ticket, {
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                        'Authorization': token
                    }
                })
                .then(response => {
                    this.successMessage = 'Ticket generated successfully';
                    console.log(this.successMessage)
                    setTimeout(this.clearMessages,3000);
                })
                .catch(error => {
                    this.errorMessage =`Error generating  Ticket: ${error}`;
                    console.error(this.errorMessage)
                    setTimeout(this.clearMessages,3000);
                });
            },
            getEventTickets() {
                const token = localStorage.getItem('token');
                axios.get(`/tickets/${this.institutionId}/events/${this.eventId}/tickets`, {
                    headers: {
                        'Authorization': token
                    }
                })
                .then(response => {
                    console.log('Event Tickets:', response.data);
                    this.tickets = response.data.map(ticket => ({
                        amount: ticket.amount,
                        name: ticket.name,
                        phone: ticket.phone,
                        paymentNumber: ticket.paymentNumber,
                        paymentTime: ticket.paymentTime,
                        valid: ticket.valid,
                        validated: ticket.validated
                    }));
                    this.showTable2 = true;
                })
                .catch(error => {
                    console.error('Error fetching event tickets:', error);
                });
            },
            handleFileUpload(event) {
                this.file = event.target.files[0];
            },
        
            generateTicketByExcel() {
                const token = localStorage.getItem('token');
                const url = `/tickets/generateTicketsFromExcelFile`;
                const institutionId = this.$el.getAttribute('data-institution-id');
                const eventId = this.$el.getAttribute('data-event-id');
                const eventID = '{{event_data.eventID}}';
                console.log('eventID:',eventID)
          
                if (!this.file) {
                  alert("Please select an Excel file first.");
                  return;
                }
          
                const formData = new FormData();
                formData.append('file', this.file);
                formData.append('instId', institutionId);
                formData.append('eventId', eventID);
                formData.append('categ_id', this.excel_data.categ_id);
                axios.post(url, formData, {
                  headers: {
                    'X-CSRFToken': "{{ csrf_token }}",
                    'Authorization': token,
                    'Content-Type': 'multipart/form-data'
                  }
                })
                .then(response => {
                  this.successMessage = 'Tickets generated successfully';
                  console.log(this.successMessage)
                  setTimeout(this.clearMessages,3000);
                })
                .catch(error => {
                    this.errorMessage =`Error generating  Ticket(s): ${error}`;
                    console.log(this.errorMessage)
                    setTimeout(this.clearMessages,3000);
                });
              },
          
              triggerFileInput() {
                console.log('Triggering file input');
                const fileInput = this.$refs.hiddenExcelFile;
                if (fileInput) {
                  console.log('File input found');
                  this.showExcelForm = true;
                } else {
                  console.error('File input not found');
                }
              },
              sendSmsTicket(){
                const token = localStorage.getItem('token');
                const url = `/tickets/sms/ticket`;
                const institutionId = this.$el.getAttribute('data-institution-id');
                const eventId = this.$el.getAttribute('data-event-id');
                const ticketNumber = '{{ticket.ticketNumber}}';
                console.log('ticketNumber:',ticketNumber)
                axios.post(url, {
                    ticketNumber:ticketNumber,
                    instId:institutionId,
                    eventId:eventId
                }, {
                    headers: {
                      'X-CSRFToken': "{{ csrf_token }}",
                      'Authorization': token
                    }
                  })
                  .then(response => {
                    this.successMessage = 'Sms sent  successfully';
                    console.log(this.successMessage)
                    setTimeout(this.clearMessages,3000);
                  })
                  .catch(error => {
                    this.errorMessage =`Error sending sms of   Ticket: ${error}`;
                    console.log(this.errorMessage)
                     setTimeout(this.clearMessages,3000);
                  });

              },
              clearMessages() {
                this.successMessage = '';
                this.errorMessage = '';
        }
           
            }
        
        
    });
</script>
{% endblock %}